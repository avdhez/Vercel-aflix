<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>AFLIX - Premium Streaming</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jost:wght@400;800;900&family=Aoboshi+One&display=swap');
          
        :root {  
            --primary: #e50914;  
            --bg: #050505;  
            --glass: rgba(255, 255, 255, 0.08);  
            --radius: 8px;
        }

        /* --- THE BLACK SCREEN FIX --- */
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
        
        /* 1. Show background immediately */
        html, body { background: var(--bg); color: #fff; font-family: 'Jost', sans-serif; height: 100%; overflow-x: hidden; }
        body { padding-top: 60px; }

        /* 2. Hidden content state */
        nav, #home-wrap { 
            visibility: hidden; 
            opacity: 0; 
            transition: opacity 0.5s ease; 
        }

        /* 3. Verified state */
        .verified nav, .verified #home-wrap { 
            visibility: visible; 
            opacity: 1; 
        }

        /* 4. Overlay logic: Visible by default so it's never "Nothing" */
        #token-lock-overlay { 
            position: fixed; inset: 0; background: #050505; z-index: 100000; 
            display: flex; align-items: center; justify-content: center; 
        }
        .verified #token-lock-overlay { display: none !important; }

        /* --- DESIGN UI --- */
        nav { position: fixed; top: 0; width: 100%; height: 60px; background: #000; display: flex; align-items: center; justify-content: space-between; padding: 0 4%; z-index: 1000; }
        .logo { color: var(--primary); font-size: 22px; font-weight: 900; letter-spacing: 2px; text-decoration: none; }
        #search-input { background: var(--glass); border: 0; color: #fff; padding: 10px 15px; border-radius: var(--radius); width: 160px; outline: none; font-size: 12px; }

        .section-container { padding: 10px 4%; }
        .section-title { font-size: 14px; font-weight: 800; text-transform: uppercase; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .slider { display: flex; overflow-x: auto; gap: 12px; scrollbar-width: none; min-height: 160px; }
        
        .thumb-card { flex: 0 0 auto; width: 110px; aspect-ratio: 2/3; border-radius: var(--radius); overflow: hidden; background: #111; border: 1px solid var(--glass); cursor: pointer; }
        .thumb-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: 0.3s; }
        .thumb-card img.loaded { opacity: 1; }

        @keyframes shimmer { 0% { background-position: -468px 0; } 100% { background-position: 468px 0; } }
        .skeleton { background: #1a1a1a; background-image: linear-gradient(to right, #1a1a1a 0%, #252525 20%, #1a1a1a 40%, #1a1a1a 100%); background-size: 800px 100%; animation: shimmer 1.5s infinite linear; }

        /* --- MODAL --- */
        #post-modal { display: none; position: fixed; inset: 0; z-index: 10001; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); }
        .modal-content { max-width: 420px; width: 90%; margin: 5vh auto; background: #000; border-radius: 15px; border: 1px solid #222; position: relative; overflow: hidden; }
        .close-x { position: absolute; top: 15px; right: 15px; font-size: 25px; color: #fff; cursor: pointer; z-index: 10; width: 40px; height: 40px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; border-radius: 50%; }

        .info-block { padding: 20px; display: flex; gap: 15px; }
        .m-poster-box { width: 100px; height: 150px; border-radius: 10px; overflow: hidden; flex-shrink: 0; border: 1px solid #333; }
        .m-title { font-size: 18px; font-weight: 900; margin-bottom: 5px; text-transform: uppercase; }
        .m-desc { color: #888; font-size: 12px; line-height: 1.4; height: 60px; overflow-y: auto; margin-top: 10px; border-top: 1px solid #222; padding-top: 8px; }

        .btn-group { display: flex; gap: 10px; padding: 10px 20px; }
        .tgl-btn { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #111; color: #666; font-weight: 800; cursor: pointer; text-transform: uppercase; }
        .tgl-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        
        #links-engine { padding: 10px 20px 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .gen-btn { background: var(--primary); color: #fff; border: none; padding: 15px; border-radius: 10px; font-weight: 800; width: 100%; cursor: pointer; margin-top: 10px; text-transform: uppercase; font-family: inherit; }
    </style>
</head>
<body>

    <div id="token-lock-overlay">
        <div style="background:#000; padding:40px 25px; border-radius:25px; border:1px solid #333; max-width:320px; width:85%; text-align:center;">
            <h2 style="color:var(--primary); font-size:22px; margin-bottom:10px; font-weight:900;">Access Locked</h2>
            <p style="color:#888; margin-bottom:20px; font-size: 13px;">Unlock your 3-hour access by getting a token.</p>
            <button class="gen-btn" id="main-gen-btn" onclick="startTokenGeneration()">Unlock Access</button>
            <button class="gen-btn" style="background:#222; font-size:11px;" onclick="window.open('https://zzlinkshh.blogspot.com/p/blog-page.html?m=1')">Tutorial</button>
        </div>
    </div>

    <nav>
        <a class="logo" href="/">AFLIX</a>
        <input id="search-input" placeholder="Search..." type="text">
    </nav>

    <div id="home-wrap">
        <div class="section-container" data-type="latest"><div class="section-title">Recently Added</div><div class="slider"></div></div>
        <div class="section-container" data-label="Action"><div class="section-title">Action</div><div class="slider"></div></div>
        <div class="section-container" data-label="Romance"><div class="section-title">Romance</div><div class="slider"></div></div>
    </div>

    <div id="post-modal">
        <span class="close-x" onclick="closeModal()">Ã—</span>
        <div class="modal-content">
            <div class="info-block">
                <div class="m-poster-box skeleton"><img id="m-poster" style="width:100%;height:100%;object-fit:cover;"></div>
                <div class="m-summary-box">
                    <h2 class="m-title" id="m-title"></h2>
                    <div id="m-meta" style="font-size:11px; color:var(--primary); font-weight:800;"></div>
                    <div class="m-desc" id="m-summary"></div> 
                </div>
            </div>
            <div class="btn-group">
                <button class="tgl-btn active" id="btn-watch">Watch</button>
                <button class="tgl-btn" id="btn-dl">Download</button>
            </div>
            <div id="links-engine"></div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        const CONFIG = {
            tokenApi: "https://tokenizer-wine.vercel.app/api/token",
            feedApi: "/api/feed",
            newDomain: "147.135.213.131:20149",
            oldDomain: "painful-elisabeth-asiantpur-8d92d39b.koyeb.app"
        };

        /* --- AUTH ENGINE (FIXED) --- */
        (async function checkAuth() {
            const urlToken = new URLSearchParams(location.search).get('token');
            const expiry = localStorage.getItem('aflix_expiry');

            // 1. Local Check (Instant)
            if (expiry && Date.now() < parseInt(expiry)) {
                return $('body').addClass('verified');
            }

            // 2. URL Check
            if (urlToken) {
                try {
                    const res = await fetch(`${CONFIG.tokenApi}?action=validate&token=${urlToken}&burn=true`);
                    const data = await res.json();
                    if (data.valid) {
                        localStorage.setItem('aflix_expiry', data.expiry);
                        $('body').addClass('verified');
                        history.replaceState({}, "", location.pathname);
                    }
                } catch (e) { console.log("Auth error"); }
            }
        })();

        async function startTokenGeneration() {
            $('#main-gen-btn').text('Generating...').prop('disabled', true);
            try {
                const res = await fetch(CONFIG.tokenApi);
                const data = await res.json();
                if (data.shortLink) location.href = data.shortLink;
            } catch (e) { alert("API Offline"); $('#main-gen-btn').text('Unlock Access').prop('disabled', false); }
        }

        /* --- CONTENT ENGINE --- */
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const slider = entry.target.querySelector('.slider');
                    const label = entry.target.dataset.label;
                    const type = entry.target.dataset.type;
                    
                    slider.innerHTML = Array(6).fill('<div class="thumb-card skeleton"></div>').join('');
                    
                    let url = type === 'latest' ? `${CONFIG.feedApi}?maxResults=15` : `${CONFIG.feedApi}?label=${label}&maxResults=15`;
                    
                    $.getJSON(url, data => {
                        if (data.feed?.entry) {
                            slider.innerHTML = data.feed.entry.map(e => {
                                const thumb = e.media$thumbnail?.url.replace(/\/s\d+(-c)?\//, '/w400/') || '';
                                return `<div class="thumb-card" onclick="openModal('${encodeURIComponent(JSON.stringify(e))}')">
                                            <img src="${thumb}" onload="this.classList.add('loaded'); this.parentElement.classList.remove('skeleton')">
                                        </div>`;
                            }).join('');
                        }
                    });
                    observer.unobserve(entry.target);
                }
            });
        });

        function openModal(dataStr) {
            const e = JSON.parse(decodeURIComponent(dataStr));
            const $cont = $('<div>').append($.parseHTML(e.content.$t));
            
            $('#m-title').text(e.title.$t.split('[')[0]);
            $('#m-poster').attr('src', e.media$thumbnail?.url.replace(/\/s\d+(-c)?\//, '/w400/'));
            $('#m-summary').text($cont.text().trim().slice(0, 150) + '...');
            
            const engine = $('#links-engine').empty();
            $cont.find('button[onclick*="http"]').each(function() {
                let btn = $(this).clone().attr('class', 'tgl-btn').css('color', '#fff');
                engine.append(btn);
            });

            $('#post-modal').fadeIn(200);
            applyLogic();
        }

        $(document).on('click', '.btn-group .tgl-btn', function() {
            $(this).addClass('active').siblings().removeClass('active');
            applyLogic();
        });

        function applyLogic() {
            const isWatch = $('#btn-watch').hasClass('active');
            $('#links-engine button').each(function() {
                let onclick = $(this).attr('onclick');
                let link = onclick.match(/https?:\/\/[^\s'"]+/)[0];
                
                if (link.includes(CONFIG.oldDomain)) link = link.replace(CONFIG.oldDomain, CONFIG.newDomain);
                
                if (isWatch) {
                    $(this).attr('onclick', `location.href='vlc://${link.replace(/^https?:\/\//, "")}'`);
                } else {
                    $(this).attr('onclick', `window.open('${link}')`);
                }
            });
        }

        function closeModal() { $('#post-modal').fadeOut(200); }
        $(document).ready(() => $('.section-container').each((i, s) => observer.observe(s)));
    </script>
</body>
</html>