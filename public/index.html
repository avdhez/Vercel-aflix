<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
<meta charset="UTF-8" />
<meta content='width=device-width, initial-scale=1, maximum-scale=1' name='viewport'/>
<title>AFLIX - Premium Streaming</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Aoboshi+One&family=Jost:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

<style>
/* --- SYSTEM --- */
:root {  
    --primary: #e50914;  
    --bg: #050505;  
    --glass: rgba(255, 255, 255, 0.08);  
    --radius: 8px;
}

* {
    -webkit-touch-callout: none !important;
    -webkit-user-select: none !important;
    user-select: none !important;
    margin:0; padding:0; box-sizing:border-box; 
}

a, button, [onclick], select, option {
    pointer-events: auto !important;
    cursor: pointer !important;
}

body {  
    background: var(--bg); color: #fff; font-family: 'Jost', sans-serif;  
    margin: 0; padding-top: 55px; overflow-x: hidden;  
    font-size: 13px; font-weight: 600; 
}

/* POPUP UI */
#popup2004-overlay { 
    position: fixed; inset: 0; background: #050505; z-index: 100000; 
    display: none; align-items: center; justify-content: center; 
}
.popup-card { 
    background:black; padding:40px 25px; border-radius:30px; border:1px solid #333; 
    max-width:320px; width:85%; text-align:center; 
}
.popup-card h2 { 
    font-family: 'Aoboshi One', serif; color:var(--primary); 
    font-size:22px; margin-bottom:10px; font-weight: 400;
}
#popup2004-timer { color: #fff; font-weight: 800; margin: 15px 0; display: block; font-size: 16px; }
#popup2004-message { color: #e50914; font-size: 12px; margin-top: 10px; display: none; font-weight: 700; }

/* REUSED APP STYLES */
nav { position: fixed; top: 0; width: 100%; height: 60px; background: black; display: flex; align-items: center; justify-content: space-between; padding: 0 4%; z-index: 1000; }
.logo { color: var(--primary); font-family: 'Aoboshi One', serif; font-size: 21px; text-decoration: none; letter-spacing: 2px; }
#search-input { background: rgba(255, 255, 255, 0.1); border: 0; color: #fff; padding: 9px 15px; border-radius: var(--radius); width: 170px; outline: none; font-family: 'Jost', sans-serif; }
#search-overlay { display: none; position: fixed; top: 60px; left: 0; width: 100%; height: calc(100vh - 60px); background: var(--bg); z-index: 999; padding: 20px 4%; overflow-y: auto; }

.section-container { padding: 2px 4%; margin-bottom: 2px; }
.section-title { font-size: 14px; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;}
.slider { display: flex; overflow-x: auto; gap: 10px; scrollbar-width: none; min-height: 150px; }
.thumb-card { flex: 0 0 auto; width: 100px; aspect-ratio: 2/3; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--glass); background: #111; }
.thumb-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: 0.3s; }
.thumb-card img.loaded { opacity: 1; }

.gen-btn { background: var(--primary); color: #fff; border: none; padding: 15px; border-radius: 10px; font-weight: 800; text-transform: uppercase; cursor: pointer; width: 100%; font-family: 'Jost', sans-serif; margin-top: 10px; }

/* MODAL SYSTEM */
#post-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); }
.close-x { position: fixed; top: 8px; right: 30px; font-size: 28px; cursor: pointer; color: #fff; z-index: 10010; width: 45px; height: 45px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; border-radius: 50%; }
.modal-content { top: 10px; max-width: 440px; width: 73%; margin: 3vh auto; background: black; border-radius: var(--radius); min-height:0vh; max-height: 92vh; overflow-y: auto; border: 1px solid #1a1a1a; position: relative; }
.info-block { padding: 15px; display: flex; gap: 18px; align-items: flex-start; background: linear-gradient(180deg, #111 0%, #000 100%); }
.m-poster-box { width: 105px; height: 155px; border-radius: var(--radius); overflow: hidden; border: 1px solid #222; flex-shrink: 0; }
.m-poster-box img { width: 100%; height: 100%; object-fit: cover; }
.m-title { font-family: 'Aoboshi One', serif; font-size: 15px; color: #fff; margin-bottom: 4px; font-weight: 400;}
.m-desc { color: #888; font-size: 13px; line-height: 1.4; height: 80px; overflow-y: auto; border-top: 1px solid #222; margin-top: 5px; padding-top: 5px; }

.toggle-group { display: flex; gap: 8px; padding: 7px 20px; }
.tgl-btn { flex: 1; padding: 9px; border-radius: var(--radius); border: 1px solid #222; background: #141414; color: #777; font-size: 13px; font-weight: 800; text-transform: uppercase; font-family: inherit; }
.tgl-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
#links-engine { padding: 5px 20px 15px; }
.ep-grid { display: none; grid-template-columns: 1fr 1fr; gap: 8px; }
.ep-grid.active { display: grid; }
.ep-grid button { text-transform: uppercase; background: #161616; color: #eee; border: 1px solid #222; padding: 10px; border-radius: var(--radius); font-size: 12px; font-weight: 700; font-family: inherit; }
</style>
</head>

<body>
  <div id='popup2004-overlay'>
    <div class='popup-card'>
      <h2>Access Locked</h2>
      <p style='color:#888; font-size:13px;'>Click unlock and stay on the page for 20 seconds to access the site for 70 minutes.</p>
      <span id="popup2004-timer">Time remaining: 20s</span>
      <button class='gen-btn' id='popup2004-link'>Unlock Now</button>
      <div id="popup2004-message">You left too early! Return and finish the timer.</div>
      <button class='gen-btn' id='popup2004-close' style='display:none; background:#22bb33;'>Enter Site</button>
    </div>
  </div>

  <nav>
    <a class='logo' href='/'>AFLIX</a>
    <input id='search-input' placeholder='Search...' type='text'/>
  </nav>

  <div id='search-overlay'>
    <div class='grid-layout' id='search-results' style='display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:12px;'></div>
  </div>

  <div id='home-wrap'>
    <div class='section-container' data-type='latest'><div class='section-title'>Recently Added &#9732;</div><div class='slider'></div></div>
    <div class='section-container' data-label='Action'><div class='section-title'>Action &#9773;</div><div class='slider'></div></div>
    <div class='section-container' data-label='Romance'><div class='section-title'>Romance &#10084;&#65038;</div><div class='slider'></div></div>
  </div>

  <div id='post-modal'>
    <span class='close-x' onclick='closeModal()'>&#215;</span>
    <div class='modal-content'>
      <div class='info-block'>
        <div class='m-poster-box skeleton' id='m-poster-wrap'><img id='m-poster' src=''/></div>
        <div class='m-summary-box'>
          <div class='m-title' id='m-title'></div>
          <div class='m-desc' id='m-summary'></div> 
        </div>
      </div>
      <div class='toggle-group'>
        <button class='tgl-btn active' id='mode-watch'>Watch</button>
        <button class='tgl-btn' id='mode-dl'>Download</button>
      </div>
      <div id='links-engine'></div>
    </div>
  </div>

<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js'></script>
<script type='text/javascript'>
// <![CDATA[
const config = { 
    feedApi: "/api/feed", 
    newDomain: "147.135.213.131:20149", 
    newProtocol: "http:", 
    oldDomain: "painful-elisabeth-asiantpur-8d92d39b.koyeb.app" 
};

/* --- POPUP 2004 LOGIC --- */
var popup2004 = {
    timer: null, secondsLeft: 20, timerRunning: false, storageKey: 'popup2004_data',
    externalUrl: 'https://otieu.com/4/9515846', lastActiveTime: null, timeSpentAway: 0, cooldownEnd: null,
    init: function() {
      this.setupElements(); this.restoreState();
      document.addEventListener('visibilitychange', this.handleVisibilityChange.bind(this));
      window.addEventListener('load', this.checkShouldShow.bind(this));
    },
    setupElements: function() {
      var p = this;
      document.getElementById('popup2004-link').addEventListener('click', function(e) { e.preventDefault(); p.handleLinkClick(); });
      document.getElementById('popup2004-close').addEventListener('click', function() { p.closePopup(); });
    },
    checkShouldShow: function() {
      if (this.cooldownEnd && Date.now() >= this.cooldownEnd) { this.cooldownEnd = null; this.saveState(); }
      if (!this.cooldownEnd) { this.showPopup(); this.updateTimerDisplay(); }
    },
    handleLinkClick: function() {
      window.open(this.externalUrl, '_blank');
      this.lastActiveTime = Date.now();
      if (!this.timerRunning) this.startTimer(); else this.resumeTimer();
    },
    startTimer: function() {
      this.secondsLeft = 20; this.timerRunning = true; this.timeSpentAway = 0;
      document.getElementById('popup2004-message').style.display = 'none';
      this.runTimer();
    },
    resumeTimer: function() {
      this.secondsLeft = Math.ceil((20000 - this.timeSpentAway) / 1000);
      this.timerRunning = true; this.runTimer();
    },
    runTimer: function() {
      if (this.timer) clearInterval(this.timer);
      var p = this;
      this.timer = setInterval(function() {
        p.secondsLeft--; p.updateTimerDisplay();
        if (p.secondsLeft <= 0) p.completeTask();
        p.saveState();
      }, 1000);
    },
    handleVisibilityChange: function() {
      if (document.visibilityState === 'visible' && this.timerRunning) {
        var timeAway = Date.now() - this.lastActiveTime;
        if (timeAway < 19000) { // Slack for return time
          clearInterval(this.timer); this.timerRunning = false;
          document.getElementById('popup2004-message').style.display = 'block';
        }
      } else if (document.visibilityState === 'hidden' && this.timerRunning) {
        this.lastActiveTime = Date.now();
      }
    },
    completeTask: function() {
      clearInterval(this.timer);
      document.getElementById('popup2004-close').style.display = 'block';
      document.getElementById('popup2004-link').style.display = 'none';
      this.cooldownEnd = Date.now() + (70 * 60 * 1000); this.saveState();
    },
    closePopup: function() { document.getElementById('popup2004-overlay').style.display = 'none'; document.body.style.overflow = ''; },
    showPopup: function() { document.getElementById('popup2004-overlay').style.display = 'flex'; document.body.style.overflow = 'hidden'; },
    restoreState: function() {
      var d = JSON.parse(localStorage.getItem(this.storageKey) || '{}');
      this.secondsLeft = d.secondsLeft || 20; this.cooldownEnd = d.cooldownEnd || null;
    },
    saveState: function() {
      localStorage.setItem(this.storageKey, JSON.stringify({secondsLeft: this.secondsLeft, cooldownEnd: this.cooldownEnd}));
    },
    updateTimerDisplay: function() { document.getElementById('popup2004-timer').textContent = 'Time remaining: ' + Math.max(0, this.secondsLeft) + 's'; }
};

/* --- ORIGINAL APP LOGIC --- */
let linkStore = new Map();

function getSmartThumb(url) { if (!url) return ''; return url.replace(/\/s\d+(-c)?\//, `/w400/`).replace(/=s\d+(-c)?/, `=w400`); }
function createCard(e) {
    let t = getSmartThumb(e.media$thumbnail ? e.media$thumbnail.url : '');
    return `<div class="thumb-card" onclick="openModal(\`${encodeURIComponent(e.content.$t)}\`, '${t}', \`${encodeURIComponent(e.title.$t)}\`, '${e.id.$t.split('post-')[1]}')">
                <img src="${t}" onload="this.parentElement.classList.remove('skeleton'); this.classList.add('loaded')" loading="lazy"/>
            </div>`;
}

$('#search-input').on('input', function() {
    let q = $(this).val();
    if(q.length > 2) {
        $('#search-overlay').show();
        $.getJSON(`${config.feedApi}?q=${q}&max-results=9`, (data) => {
            if (data.feed.entry) $('#search-results').html(data.feed.entry.map(e => createCard(e)).join(''));
        });
    } else { $('#search-overlay').hide(); }
});

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if(entry.isIntersecting) {
            const type = entry.target.getAttribute('data-type'), lbl = entry.target.getAttribute('data-label'), slider = entry.target.querySelector('.slider');
            let url = type === 'latest' ? `${config.feedApi}?max-results=15` : `${config.feedApi}?label=${lbl}&max-results=15`;
            $.getJSON(url, (data) => { if(data.feed.entry) slider.innerHTML = data.feed.entry.map(e => createCard(e)).join(''); });
            observer.unobserve(entry.target);
        }
    });
});

function openModal(encCont, thumb, encTitle, id) {
    let cont = decodeURIComponent(encCont), name = decodeURIComponent(encTitle).split(/\[| \d{4}/)[0];
    $('#m-poster').attr('src', thumb); $('#m-title').text(name);
    $('#m-summary').text($('<div>').append($.parseHTML(cont)).text().substring(0, 300) + "...");
    $('#links-engine').empty();
    let $data = $('<div>').append($.parseHTML(cont)), movieGrid = $('<div class="ep-grid active"></div>');
    $data.find('button[onclick*="http"]').each(function() { movieGrid.append($(this).clone()); });
    $('#links-engine').append(movieGrid);
    $('#post-modal').fadeIn(200);
    applyStreamLogic($('#mode-watch').hasClass('active'));
}

function applyStreamLogic(isVlc) {
    const ua = navigator.userAgent.toLowerCase();
    const isAnd = /android/.test(ua), isIos = /iphone|ipad|ipod/.test(ua);
    document.querySelectorAll('#links-engine button').forEach(btn => {
        if(!linkStore.has(btn)) linkStore.set(btn, btn.getAttribute('onclick'));
        let originalOnclick = linkStore.get(btn);
        let m = originalOnclick.match(/https?:\/\/[^\s'"]+/);
        if(m) {
            let targetUrl = m[0];
            if (targetUrl.includes(config.oldDomain)) {
                let u = new URL(targetUrl); u.hostname = config.newDomain.split(':')[0]; u.port = config.newDomain.split(':')[1] || ""; u.protocol = config.newProtocol;
                targetUrl = u.toString();
            }
            if (isVlc) {
                if (isAnd) btn.setAttribute('onclick', `window.location.href='intent://${targetUrl.replace(/^https?:\/\//,'')}#Intent;scheme=http;type=video/*;action=android.intent.action.VIEW;end'`);
                else if (isIos) btn.setAttribute('onclick', `window.location.href='vlc-x-callback://x-callback-url/stream?url=${encodeURIComponent(targetUrl)}'`);
                else btn.setAttribute('onclick', `window.location.href='vlc://${targetUrl}'`);
            } else { btn.setAttribute('onclick', `window.open('${targetUrl}')`); }
        }
    });
}

function closeModal() { $('#post-modal').fadeOut(200); }
$(document).on('click', '.tgl-btn', function() { $(this).siblings().removeClass('active'); $(this).addClass('active'); applyStreamLogic($('#mode-watch').hasClass('active')); });

$(document).ready(() => { 
    popup2004.init();
    $('.section-container').each(function() { observer.observe(this); }); 
});
// ]]>
</script>
</body>
</html>