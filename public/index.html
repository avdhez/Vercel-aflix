<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>AFLIX - Premium Streaming</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,100..900;1,100..900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Aoboshi+One&display=swap');
          
        :root {  
            --primary: #e50914;  
            --bg: #050505;  
            --glass: rgba(255, 255, 255, 0.08);  
            --radius: 8px;
        }

        /* --- SYSTEM & ANTI-FLICKER --- */
        * {
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            user-select: none !important;
            -webkit-tap-highlight-color: transparent !important;
            margin:0; padding:0; box-sizing:border-box; 
        }

        /* Elements are hidden until .verified class is added to <html> */
        nav, #home-wrap { opacity: 0; pointer-events: none; transition: opacity 0.4s ease;}
        .verified nav, .verified #home-wrap { opacity: 1; pointer-events: auto; }

        /* Lock Overlay is visible by default */
        #token-lock-overlay { 
            position: fixed; inset: 0; background: #050505; z-index: 100000; 
            display: flex; align-items: center; justify-content: center; 
            visibility: visible; opacity: 1;
        }
        .verified #token-lock-overlay { display: none !important; visibility: hidden !important; opacity: 0; }

        html, body { height: 100%; background: var(--bg); color: #fff; font-family: 'Jost', serif; font-size: 13px; font-weight: 600; overflow-x: hidden; }
        body { padding-top: 55px; }
        body.search-open, body.modal-open { overflow: hidden !important; }

        a, button, [onclick] { pointer-events: auto !important; cursor: pointer !important; text-decoration: none; }

        /* --- UI --- */
        nav { position: fixed; top: 0; width: 100%; height: 60px; background: black; display: flex; align-items: center; justify-content: space-between; padding: 0 4%; z-index: 1000; box-sizing: border-box; }
        .logo { color: var(--primary); font-size: 21px; font-weight: 900; letter-spacing: 2px; }
        #search-input { background: rgba(255, 255, 255, 0.1); border: 0; color: #fff; padding: 9px 15px; border-radius: var(--radius); width: 170px; outline: none; font-size: 12px; font-weight: 800; text-transform: uppercase; font-family: inherit; letter-spacing: 1px;}
        
        #search-overlay { display: none; position: fixed; top: 60px; left: 0; width: 100%; height: calc(100vh - 60px); background: var(--bg); z-index: 999; padding: 20px 4%; box-sizing: border-box; overflow-y: auto; }

        @keyframes shimmer { 0% { background-position: -468px 0; } 100% { background-position: 468px 0; } }
        .skeleton { background: #1a1a1a; background-image: linear-gradient(to right, #1a1a1a 0%, #252525 20%, #1a1a1a 40%, #1a1a1a 100%); background-repeat: no-repeat; background-size: 800px 100%; animation: shimmer 1.5s infinite linear forwards; border-radius: var(--radius); }

        #home-wrap { min-height: calc(100vh - 60px); height: auto; display: block; }
        .section-container { padding: 2px 4%; margin-bottom: 2px; }
        .section-title { font-size: 14px; font-weight: 800; color: #fff; text-transform: uppercase; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;}
        .slider { display: flex; overflow-x: auto; gap: 10px; scrollbar-width: none; min-height: 150px; }
        
        .thumb-card { flex: 0 0 auto; width: 100px; aspect-ratio: 2/3; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--glass); background: #111; cursor: pointer; }
        .thumb-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: 0.3s; }
        .thumb-card img.loaded { opacity: 1; }

        /* --- MODAL --- */
        #post-modal { display: none; position: fixed; inset: 0; z-index: 10001; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(10px); }
        .modal-content { max-width: 440px; width: 85%; margin: 3vh auto; background: black; border-radius: var(--radius); max-height: 92vh; overflow-y: auto; border: 1px solid #1a1a1a; position: relative; box-shadow: 0 20px 60px rgba(0, 0, 0, 1); }
        .close-x { position: fixed; top: 8px; right: 20px; font-size: 28px; cursor: pointer; color: #fff; z-index: 10010; width: 45px; height: 45px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        
        .info-block { padding: 15px; display: flex; gap: 18px; align-items: flex-start; }
        .m-poster-box { width: 105px; height: 155px; border-radius: var(--radius); overflow: hidden; border: 1px solid #222; flex-shrink: 0; }
        .m-title { font-size: 15px; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; }
        .m-desc { color: #888; font-size: 13px; line-height: 1.4; border-top: 1px solid #222; margin-top: 5px; padding-top: 5px; }

        .toggle-group { display: flex; gap: 8px; padding: 7px 20px; }
        .tgl-btn { flex: 1; padding: 10px; border-radius: var(--radius); border: 1px solid #222; background: #141414; color: #777; font-weight: 800; text-transform: uppercase; font-family: inherit; cursor: pointer; }
        .tgl-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        #links-engine { padding: 5px 20px 15px; }
        .ep-grid { display: none; grid-template-columns: 1fr 1fr; gap: 8px; }
        .ep-grid.active { display: grid; }
        .ep-grid button { text-transform: uppercase; background: #161616; color: #eee; border: 1px solid #222; padding: 10px; border-radius: var(--radius); font-size: 12px; font-weight: 700; font-family: inherit; }
        .gen-btn { background: var(--primary); color: #fff; border: none; padding: 15px; border-radius: 10px; font-weight: 800; text-transform: uppercase; width: 100%; margin: 5px 0; font-family: inherit;}
    </style>
</head>
<body>

    <div id="token-lock-overlay">
        <div style="background:black; padding:40px 25px; border-radius:30px; border:1px solid #333; max-width:320px; width:85%; text-align:center;">
            <h2 style="color:var(--primary); font-size:22px; margin-bottom:10px; font-weight:900;">Restricted Access</h2>
            <p style="color:#888; margin-bottom:20px;">Unlock your 3-hour access by bypassing the shortener link.</p>
            <button class="gen-btn" id="main-gen-btn" onclick="startTokenGeneration()">Unlock Access</button>
            <button class="gen-btn" style="background:#222;" onclick="window.open('https://zzlinkshh.blogspot.com/p/blog-page.html?m=1')">How To Get Access</button>
        </div>
    </div>

    <nav>
        <a class="logo" href="/">AFLIX</a>
        <input id="search-input" placeholder="SEARCH..." type="text"/>
    </nav>

    <div id="search-overlay">
        <div id="search-results" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:12px;"></div>
    </div>

    <div id="home-wrap">
        <div class="section-container" data-type="latest"><div class="section-title">Recently Added ☄️</div><div class="slider"></div></div>
        <div class="section-container" data-label="Action"><div class="section-title">Action ⚔️</div><div class="slider"></div></div>
        <div class="section-container" data-label="Romance"><div class="section-title">Romance ❤️</div><div class="slider"></div></div>
    </div>

    <div id="post-modal">
        <span class="close-x" onclick="closeModal()">×</span>
        <div class="modal-content">
            <div class="info-block">
                <div class="m-poster-box skeleton" id="m-poster-wrap"><img id="m-poster" src=""/></div>
                <div class="m-summary-box">
                    <div class="m-title" id="m-title"></div>
                    <div class="m-meta-item"><b>Lang:</b> <span id="m-langs">-</span></div>
                    <div class="m-meta-item"><b>Subs:</b> <span id="m-subs">None</span></div>
                    <div class="m-desc" id="m-summary"></div> 
                </div>
            </div>
            <div class="toggle-group">
                <button class="tgl-btn active" id="mode-watch">Watch</button>
                <button class="tgl-btn" id="mode-dl">Download</button>
            </div>
            <div class="toggle-group" id="season-wrap" style="display:none; padding-top:0;">
                <select id="season-select" onchange="updateEngine()" style="width:100%; padding:12px; background:#161616; color:#fff; border-radius:8px; border:1px solid #222; font-family:inherit; font-weight:700; text-transform: uppercase; outline: none;"></select>
            </div>
            <div id="links-engine"></div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        const config = { 
            vercelApi: "https://tokenizer-wine.vercel.app/api/token", 
            feedProxy: "/api/feed", // USE THE API WE CODED
            newDomain: "147.135.213.131:20149", 
            newProtocol: "http:", 
            oldDomain: "painful-elisabeth-asiantpur-8d92d39b.koyeb.app" 
        };

        let linkStore = new Map(), currentId = "", searchTimer;

        /* --- AUTH ENGINE --- */
        (async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            const savedExpiry = localStorage.getItem('aflix_access_expiry');

            if (savedExpiry && Date.now() < parseInt(savedExpiry)) {
                $('html').addClass('verified');
                return;
            }

            if (urlToken) {
                try {
                    const res = await fetch(`${config.vercelApi}?action=validate&token=${urlToken}&burn=true`);
                    const data = await res.json();
                    if (data.valid) {
                        localStorage.setItem('aflix_access_expiry', data.expiry);
                        $('html').addClass('verified');
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (e) { console.log("Auth error"); }
            }
        })();

        async function startTokenGeneration() {
            $('#main-gen-btn').text('Redirecting...').prop('disabled', true);
            try {
                const res = await fetch(config.vercelApi);
                const data = await res.json();
                if (data.shortLink) window.location.href = data.shortLink;
            } catch (e) { alert("API Offline"); $('#main-gen-btn').text('Unlock Access').prop('disabled', false); }
        }

        /* --- CONTENT ENGINE --- */
        function getSmartThumb(url) { if (!url) return ''; return url.replace(/\/s\d+(-c)?\//, `/w400/`).replace(/=s\d+(-c)?/, `=w400`); }
        
        function createCard(e) {
            let t = getSmartThumb(e.media$thumbnail ? e.media$thumbnail.url : '');
            return `<div class="thumb-card" onclick="openModal(\`${encodeURIComponent(e.content.$t)}\`, '${t}', \`${encodeURIComponent(e.title.$t)}\`, '', '${e.id.$t.split('post-')[1]}')">
                        <img src="${t}" onload="this.parentElement.classList.remove('skeleton'); this.classList.add('loaded')"/>
                    </div>`;
        }

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if(entry.isIntersecting) {
                    const type = entry.target.getAttribute('data-type'), lbl = entry.target.getAttribute('data-label'), slider = entry.target.querySelector('.slider');
                    slider.innerHTML = Array(8).fill('<div class="thumb-card skeleton"></div>').join('');
                    
                    // FETCH FROM THE API PROXY
                    let url = type === 'latest' ? `${config.feedProxy}?maxResults=15` : `${config.feedProxy}?label=${lbl}&maxResults=15`;
                    $.getJSON(url, (data) => { if(data.feed.entry) slider.innerHTML = data.feed.entry.map(e => createCard(e)).join(''); });
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });

        $('#search-input').on('input', function() {
            clearTimeout(searchTimer);
            let q = $(this).val();
            if(q.length > 2) {
                $('#search-overlay').show(); $('body').addClass('search-open');
                $.getJSON(`${config.feedProxy}?q=${q}&maxResults=9`, (data) => {
                    $('#search-results').html(data.feed.entry ? data.feed.entry.map(e => createCard(e)).join('') : 'No results.');
                });
            } else if(q.length === 0) {
                $('#search-overlay').hide(); $('body').removeClass('search-open');
            }
        });

        function openModal(encCont, thumb, encTitle, tags, id) {
            let fullTitle = decodeURIComponent(encTitle);
            let cont = decodeURIComponent(encCont), $html = $('<div>').append($.parseHTML(cont));
            
            $('#m-poster-wrap').addClass('skeleton'); 
            $('#m-poster').attr('src', thumb); 
            $('#m-title').text(fullTitle.split('[')[0]); 
            $('#m-summary').text($html.text().trim().substring(0, 200) + '...');
            
            $('#links-engine, #season-select').empty(); $('#season-wrap').hide();

            let episodes = $html.find('.episodes');
            if(episodes.length > 0) {
                $('#season-wrap').show();
                episodes.each(function(i) {
                    $('#season-select').append(`<option value="${i+1}">Season ${i+1}</option>`);
                    let grid = $('<div class="ep-grid"></div>').attr('id', `s${i+1}`);
                    $(this).find('button').each(function() { grid.append($(this).clone()); });
                    $('#links-engine').append(grid);
                });
            } else {
                let movieGrid = $('<div class="ep-grid active"></div>');
                $html.find('button[onclick*="http"]').each(function() { movieGrid.append($(this).clone()); });
                $('#links-engine').append(movieGrid);
            }
            $('#post-modal').fadeIn(200); updateEngine();
        }

        function updateEngine() {
            $('.ep-grid').removeClass('active');
            let s = $('#season-select').val() || "1";
            $(`#s${s}`).addClass('active');
            applyStreamLogic($('#mode-watch').hasClass('active'));
        }

        function applyStreamLogic(isVlc) {
            document.querySelectorAll('#links-engine button').forEach(btn => {
                let originalOnclick = btn.getAttribute('onclick');
                let m = originalOnclick.match(/https?:\/\/[^\s'"]+/);
                if(m) {
                    let targetUrl = m[0];
                    if (targetUrl.includes(config.oldDomain)) {
                        targetUrl = targetUrl.replace(config.oldDomain, config.newDomain);
                    }
                    if (isVlc) btn.setAttribute('onclick', `window.location.href='vlc://${targetUrl}'`);
                    else btn.setAttribute('onclick', `window.open('${targetUrl}')`);
                }
            });
        }

        function closeModal() { $('#post-modal').fadeOut(200); }
        $(document).ready(() => { $('.section-container').each(function() { observer.observe(this); }); });
    </script>
</body>
</html>